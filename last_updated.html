<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Última actualización del servicio</title>
<style>
  :root {
    --font: system-ui, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
    --color-text: #1f2937;
    --color-muted: #6b7280;
    --color-ok: #065f46;
    --color-bad: #7f1d1d;
    --bg: #ffffff;
    --pill-bg: #f3f4f6;
  }
  html, body {
    margin: 0;
    padding: 0;
    background: var(--bg);
    color: var(--color-text);
    font: 14px/1.4 var(--font);
  }
  .wrap {
    padding: 10px 12px;
  }
  .label {
    display: block;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .value {
    display: inline-block;
    background: var(--pill-bg);
    padding: 6px 10px;
    border-radius: 8px;
    font-variant-numeric: tabular-nums;
  }
  .small {
    display: block;
    margin-top: 6px;
    color: var(--color-muted);
    font-size: 12px;
  }
  .error {
    color: var(--color-bad);
    font-weight: 600;
  }
</style>
</head>
<body>
<div class="wrap">
  <span class="label">Última actualización del servicio</span>
  <span id="last-updated" class="value">Cargando…</span>
  <small id="details" class="small"></small>
</div>

<script>
/**
 * Configuración
 * - layerUrl: URL del endpoint de capa en ArcGIS REST con ?f=json
 * - locale: formato regional para la fecha
 * - refreshMs: intervalo de auto-refresco (0 = sin auto-refresco)
 */
const CONFIG = {
  layerUrl: 'https://geo.bcr.gob.sv/server/rest/services/Hosted/Puntos_visitados/FeatureServer/8?f=json',
  locale: 'es-SV',
  refreshMs: 0 // por ejemplo 30000 para 30 s, 60000 para 1 min
};

const $value = document.getElementById('last-updated');
const $details = document.getElementById('details');

async function fetchLastUpdated() {
  try {
    $value.textContent = 'Cargando…';
    $details.textContent = '';

    const res = await fetch(CONFIG.layerUrl, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);

    const json = await res.json();

    // 1) Preferir editingInfo.lastEditDate
    let ts = json?.editingInfo?.lastEditDate;

    // 2) Alternativa común en algunos servicios
    if (!ts && json?.lastEditDate) ts = json.lastEditDate;

    if (!ts) {
      $value.textContent = 'No disponible';
      $value.classList.add('error');
      $details.textContent = 'El servicio no expone editingInfo.lastEditDate/lastEditDate.';
      return;
    }

    const dt = new Date(ts);
    const fmt = new Intl.DateTimeFormat(CONFIG.locale, {
      day: '2-digit', month: '2-digit', year: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    }).format(dt);

    $value.textContent = fmt;

    // Info adicional (opcional)
    const layerName = json?.name || json?.layerName || '';
    $details.textContent = [
      layerName ? `Capa: ${layerName}` : null,
      `Fuente: ${CONFIG.layerUrl.split('?')[0]}`,
      `Zona horario navegador`
    ].filter(Boolean).join(' · ');
  } catch (e) {
    console.error(e);
    $value.textContent = 'Error al consultar';
    $value.classList.add('error');
    $details.textContent = 'Verifica conectividad, CORS y accesibilidad pública del servicio.';
  }
}

// Primera carga
fetchLastUpdated();

// Auto–refresh si se configura
if (CONFIG.refreshMs && CONFIG.refreshMs > 0) {
  setInterval(fetchLastUpdated, CONFIG.refreshMs);
}
</script>
</body>
</html>